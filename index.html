<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Cache-Control" content="no-store, max-age=0, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Orientation</title>

  <!-- ⬆️ Incrémente à chaque déploiement pour invalider le cache -->
  <script>window.APP_VERSION = "2025-10-07-01";</script>

  <!-- CSS versionné -->
  <link rel="stylesheet" href="./style.css?v=2025-10-07-01" />

  <!-- (optionnel) export image dernière page si tu l’utilises -->
  <script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <!-- Désinscription SW + purge caches une fois, pour éviter un ancien SW bloquant -->
  <script>
    (async () => {
      try {
        if ('serviceWorker' in navigator) {
          const regs = await navigator.serviceWorker.getRegistrations();
          for (const r of regs) await r.unregister();
        }
        if (window.caches?.keys) {
          const keys = await caches.keys();
          await Promise.all(keys.map(k => caches.delete(k)));
        }
      } catch (_) {}
    })();
  </script>
</head>
<body>
  <!-- Topbar minimaliste -->
  <header class="topbar minimal">
    <div class="brand">
      <span class="brand-title">🎒 Orientation</span>
      <button id="btnReset" class="ghost small" title="Réinitialiser">↺</button>
    </div>
    <div class="actions">
      <!-- Logo renard versionné (mets l’image dans ./assets/renard_univia.png) -->
      <img src="./assets/renard_univia.png?v=2025-10-07-01" alt="Univia" class="logo">
    </div>
  </header>

  <main id="app" class="stage-wrap">
    <!-- Carte principale (statut + contrôles + résultats) -->
    <section class="stage card" id="mainStage">
      <section id="status" class="status muted">Saisis l’ID élève et le token puis clique « Commencer ».</section>

      <section class="controls-panel">
        <div class="controls-row">
          <label for="studentId">ID élève</label>
          <input id="studentId" placeholder="ex. stu_demo" />
        </div>
        <div class="controls-row">
          <label for="apiKey">OpenAI API Key (optionnel)</label>
          <input id="apiKey" placeholder="sk-..." type="password" />
        </div>
        <div class="controls-row right">
          <button id="startBtn" class="primary">Commencer</button>
        </div>
      </section>

      <section id="results" class="hidden">
        <h2 class="section-title">Classement des universités (par score de compatibilité)</h2>

        <div class="alpha-box">
          <h3>Poids (alpha)</h3>
          <pre id="alphaView"></pre>
        </div>

        <table class="ranking">
          <thead>
            <tr>
              <th>#</th>
              <th>Université (id)</th>
              <th>Score</th>
              <th>Détails (features utilisées)</th>
            </tr>
          </thead>
          <tbody id="rankingBody"></tbody>
        </table>
      </section>
    </section>
  </main>

  <!-- Chat LLM en bas de page -->
  <section class="chat-dock">
    <div class="chat-header">
      <span>Assistant profil (LLM)</span>
      <span class="muted small">Le token saisi est utilisé côté navigateur et n’est pas stocké.</span>
    </div>
    <div id="chatLog" class="chat-log"></div>
    <div class="chat-input-row">
      <textarea id="chatInput" class="chat-input" placeholder="Décris tes préférences, ton budget, tes contraintes… (ex.: « campus urbain, IELTS 7.0, budget 40k€ »)"></textarea>
      <button id="chatSend" class="btn primary">Envoyer</button>
    </div>
  </section>

  <footer class="footer">
    <small>Static UI — lit <code>./data/*.json</code> et <code>./normalized/*.json</code>. Le chat appelle OpenAI si un token est saisi.</small>
  </footer>

  <!-- JS versionné -->
  <script defer src="./app.js?v=2025-10-07-01"></script>
</body>
</html>
